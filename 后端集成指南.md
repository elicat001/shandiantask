# 后端系统集成指南

恭喜！后端系统已经搭建完成，现在我来详细说明如何使用和管理它。

## 🎉 已完成的工作

### 1. 后端架构搭建 ✅
- **Express服务器**: 运行在端口5000上
- **SQLite数据库**: 使用Prisma ORM管理
- **JWT认证系统**: 完整的用户注册、登录、认证机制
- **RESTful API**: 标准的REST接口设计

### 2. 数据模型设计 ✅
已创建以下数据表：
- **User**: 用户表（包含认证信息）
- **Task**: 任务表（核心业务数据）
- **List**: 列表表（任务分组）
- **SubTask**: 子任务表
- **Tag**: 标签表
- **Note**: 笔记表
- **CalendarEvent**: 日历事件表
- **PomodoroSession**: 番茄钟记录表
- **Challenge**: 挑战表

### 3. API端点实现 ✅
已实现的核心API：
- 用户认证（注册、登录、登出）
- 任务管理（增删改查）
- 列表管理
- 批量操作支持

### 4. 安全机制 ✅
- 密码bcrypt加密
- JWT Token认证
- CORS跨域配置
- 请求验证和错误处理

## 🚀 如何使用后端

### 启动后端服务

1. **打开终端，进入后端目录**：
```bash
cd backend
```

2. **启动开发服务器**：
```bash
npm run dev
```

你会看到：
```
🚀 服务器启动成功！
📡 API地址: http://localhost:5000
🌍 前端地址: http://localhost:3000
```

### 测试API

我已经创建了测试用户：
- **用户名**: testuser
- **密码**: Test123456
- **邮箱**: test@example.com

你可以用Postman或其他工具测试API。

### 查看数据库

使用Prisma Studio可视化查看数据：
```bash
cd backend
npx prisma studio
```

浏览器会自动打开 http://localhost:5555，你可以直接查看和编辑数据。

## 📋 日常操作

### 1. 添加新用户
通过API注册：
```bash
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"new@example.com","username":"newuser","password":"Pass123"}'
```

### 2. 重置数据库
如果需要清空所有数据重新开始：
```bash
cd backend
npx prisma migrate reset
```

### 3. 修改数据模型
1. 编辑 `backend/prisma/schema.prisma`
2. 创建迁移：`npx prisma migrate dev --name 描述`
3. 重新生成客户端：`npx prisma generate`

## 🔧 常见问题解决

### 问题1: 端口被占用
错误信息：`Error: listen EADDRINUSE: address already in use :::5000`

**解决方案**：
1. 修改 `backend/.env` 中的 `PORT=5001`
2. 或者关闭占用5000端口的程序

### 问题2: 数据库连接失败
错误信息：`The table main.User does not exist`

**解决方案**：
```bash
cd backend
npx prisma migrate dev
npx prisma generate
```

### 问题3: Token验证失败
错误信息：`未授权：token无效或已过期`

**解决方案**：
- 重新登录获取新token
- 检查请求头是否正确：`Authorization: Bearer <token>`

### 问题4: 中文乱码
**解决方案**：
- 确保请求头包含：`Content-Type: application/json; charset=utf-8`
- 数据库已配置UTF-8编码

## 📝 前端集成步骤

我已经创建了 `src/services/api.ts` 文件，包含所有API调用方法。

### 使用示例：

```javascript
import api from '@/services/api';

// 登录
const loginResult = await api.auth.login({
  emailOrUsername: 'testuser',
  password: 'Test123456'
});

// 获取任务
const tasks = await api.task.getTasks();

// 创建任务
const newTask = await api.task.createTask({
  title: '新任务',
  description: '任务描述'
});
```

### 在Zustand中集成

修改 `src/store/useStore.ts`，添加API调用：

```javascript
// 示例：登录操作
login: async (emailOrUsername: string, password: string) => {
  try {
    const response = await api.auth.login({ emailOrUsername, password });
    if (response.success) {
      set({ user: response.data.user });
      return true;
    }
  } catch (error) {
    console.error('登录失败:', error);
    return false;
  }
}
```

## 📚 后端文档位置

详细的API文档在：`backend/README.md`

包含：
- 所有API端点详细说明
- 请求/响应示例
- 错误码说明
- 部署指南

## ✨ 下一步建议

1. **完成前端集成**：
   - 修改store使用真实API
   - 添加loading状态
   - 处理错误提示

2. **添加更多功能**：
   - 文件上传（头像、附件）
   - 实时通知（WebSocket）
   - 数据导出功能

3. **性能优化**：
   - 添加Redis缓存
   - 实现分页查询
   - 优化数据库索引

4. **准备部署**：
   - 配置生产环境变量
   - 设置HTTPS
   - 添加日志系统

## 🤝 需要帮助？

如果遇到任何问题：
1. 查看 `backend/README.md` 详细文档
2. 检查服务器控制台输出
3. 使用 `npx prisma studio` 查看数据
4. 告诉我具体错误信息，我会帮你解决

## 🎊 总结

后端系统已经完全搭建好了！包括：
- ✅ 完整的认证系统
- ✅ 数据库和ORM
- ✅ RESTful API
- ✅ 安全机制
- ✅ 详细文档
- ✅ 测试数据

现在你可以：
1. 使用现有API进行前端开发
2. 根据需要扩展新功能
3. 准备部署到生产环境

记住：
- 后端运行在: http://localhost:5000
- 数据库文件在: backend/dev.db
- 环境配置在: backend/.env

祝你开发顺利！有任何问题随时问我。